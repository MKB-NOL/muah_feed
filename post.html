<!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";
    import { getFirestore, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
      authDomain: "muah-feed.firebaseapp.com",
      databaseURL: "https://muah-feed-default-rtdb.firebaseio.com",
      projectId: "muah-feed",
      storageBucket: "muah-feed.firebasestorage.app",
      messagingSenderId: "442314397706",
      appId: "1:442314397706:web:ebd610cf623b01253667f3",
      measurementId: "G-FGBFJFBLM7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const dbRealtime = getDatabase(app);
    const dbFirestore = getFirestore(app);

    // Load Post
    function loadPost() {
      const postIndex = 1; // For post1.html (newest post)
      let allPosts = [];

      // Realtime Database Posts
      const postsRefRealtime = ref(dbRealtime, 'posts');
      onValue(postsRefRealtime, (snapshot) => {
        const posts = [];
        snapshot.forEach((childSnapshot) => {
          posts.push({ id: childSnapshot.key, source: 'realtime', ...childSnapshot.val() });
        });
        updatePosts(posts);
      });

      // Firestore Posts
      const postsRefFirestore = collection(dbFirestore, 'posts');
      onSnapshot(postsRefFirestore, (snapshot) => {
        const posts = [];
        snapshot.forEach((doc) => {
          posts.push({ id: doc.id, source: 'firestore', ...doc.data() });
        });
        updatePosts(posts);
      });

      function updatePosts(newPosts) {
        allPosts = [...allPosts.filter(p => !newPosts.some(np => np.id === p.id && np.source === p.source)), ...newPosts];
        allPosts.sort((a, b) => b.timestamp - a.timestamp); // Sort by timestamp descending
        renderPost();
      }

      function renderPost() {
        const post = allPosts[postIndex - 1]; // 0-based index
        if (!post) {
          document.getElementById('post-content').innerHTML = `
            <div class="text-center py-12">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">Post Not Found</h2>
              <p class="text-gray-600">The requested post does not exist.</p>
              <a href="/" class="mt-6 inline-block bg-primary-600 hover:bg-primary-700 text-white font-semibold px-6 py-2 rounded-lg transition duration-300">Back to Home</a>
            </div>
          `;
          return;
        }

        // Update Title
        document.getElementById('post-title').textContent = post.title;

        // Update Image
        const postImage = document.getElementById('post-image').querySelector('img');
        postImage.src = post.imageUrl || 'https://via.placeholder.com/800x400?text=' + encodeURIComponent(post.title);
        postImage.alt = post.title;

        // Update Date and Read Time
        document.getElementById('post-date').textContent = new Date(post.timestamp).toLocaleDateString();
        document.getElementById('post-read-time').textContent = `${Math.ceil(post.content.replace(/<[^>]+>/g, '').length / 200)} min read`;

        // Update YouTube Video
        const youtubeContainer = document.getElementById('post-youtube');
        if (post.youtube && post.youtube.includes('youtube.com')) {
          const videoId = post.youtube.match(/(?:v=)([^&]+)/)?.[1] || post.youtube.match(/youtu\.be\/([^?]+)/)?.[1];
          if (videoId) {
            youtubeContainer.querySelector('iframe').src = `https://www.youtube.com/embed/${videoId}`;
            youtubeContainer.classList.remove('hidden');
          }
        }

        // Update Content
        document.getElementById('post-text').innerHTML = post.content;
      }
    }

    // Initialize Post on Page Load
    loadPost();

    // Form Submission
    const postForm = document.getElementById('post-form');
    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const adminPassword = document.getElementById('admin-password').value;
      const title = document.getElementById('title').value;
      const content = quill.root.innerHTML;
      const youtube = document.getElementById('youtube').value;
      const imageFile = document.getElementById('image').files[0];

      // Basic admin check (replace 'mysecretpassword' with your own)
      if (adminPassword !== 'mysecretpassword') {
        alert('Invalid admin password!');
        return;
      }

      let imageUrl = '';
      if (imageFile) {
        // Upload image to ImgBB
        const formData = new FormData();
        formData.append('image', imageFile);
        try {
          const response = await fetch('https://api.imgbb.com/1/upload?key=4912b692896a9dd8bb0835068f4c20e3', {
            method: 'POST',
            body: formData
          });
          const data = await response.json();
          if (data.success) {
            imageUrl = data.data.url;
          } else {
            throw new Error('Image upload failed');
          }
        } catch (error) {
          alert(`Image upload error: ${error.message}`);
          return;
        }
      }

      // Save post to Firestore (instead of Realtime Database)
      try {
        const docRef = await addDoc(collection(dbFirestore, 'posts'), {
          title: title,
          content: content,
          imageUrl: imageUrl,
          youtube: youtube || '',
          timestamp: Date.now()
        });
        
        postForm.reset();
        quill.setContents([]);
        alert(`Post submitted successfully with ID: ${docRef.id}`);
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    });

    // Search Functionality (Copied from index.html for consistency)
    const searchInput = document.getElementById('search');
    const searchResults = document.getElementById('search-results');
    let allPosts = [];
    let debounceTimeout;

    function debounce(func, wait) {
      return function (...args) {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function loadSearchPosts() {
      const postsRefRealtime = ref(dbRealtime, 'posts');
      onValue(postsRefRealtime, (snapshot) => {
        const posts = [];
        snapshot.forEach((childSnapshot) => {
          posts.push({ id: childSnapshot.key, source: 'realtime', ...childSnapshot.val() });
        });
        updateSearchPosts(posts);
      });

      const postsRefFirestore = collection(dbFirestore, 'posts');
      onSnapshot(postsRefFirestore, (snapshot) => {
        const posts = [];
        snapshot.forEach((doc) => {
          posts.push({ id: doc.id, source: 'firestore', ...doc.data() });
        });
        updateSearchPosts(posts);
      });
    }

    function updateSearchPosts(newPosts) {
      allPosts = [...allPosts.filter(p => !newPosts.some(np => np.id === p.id && np.source === p.source)), ...newPosts];
      allPosts.sort((a, b) => b.timestamp - a.timestamp);
      updateSearchResults(searchInput.value);
    }

    function updateSearchResults(query) {
      query = query.trim().toLowerCase();
      searchResults.innerHTML = '';
      if (!query) {
        searchResults.classList.add('hidden');
        return;
      }

      const filteredPosts = allPosts
        .filter(post => post.title.toLowerCase().includes(query))
        .slice(0, 5);

      if (filteredPosts.length === 0) {
        searchResults.innerHTML = `
          <div class="p-4 text-gray-600 text-center">
            No results found for "${query}"
          </div>
        `;
        searchResults.classList.remove('hidden');
        return;
      }

      filteredPosts.forEach((post, index) => {
        const resultItem = document.createElement('a');
        resultItem.href = `posts/post${allPosts.indexOf(post) + 1}.html`;
        resultItem.className = 'search-result-item flex items-center p-3 border-b border-gray-200 last:border-b-0';
        resultItem.innerHTML = `
          <img src="${post.imageUrl || 'https://via.placeholder.com/50x50?text=' + encodeURIComponent(post.title)}" 
               alt="${post.title}" class="w-12 h-12 object-cover rounded-md mr-3">
          <div class="flex-1">
            <h4 class="text-sm font-semibold text-gray-800">${post.title}</h4>
            <p class="text-xs text-gray-600 truncate">${post.content.replace(/<[^>]+>/g, '').substring(0, 50)}...</p>
          </div>
        `;
        searchResults.appendChild(resultItem);
      });

      searchResults.classList.remove('hidden');
    }

    searchInput.addEventListener('input', debounce(() => {
      updateSearchResults(searchInput.value);
    }, 300));

    document.addEventListener('click', (e) => {
      if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.add('hidden');
      }
    });

    searchInput.addEventListener('focus', () => {
      if (searchInput.value.trim()) {
        updateSearchResults(searchInput.value);
      }
    });

    searchInput.addEventListener('keydown', (e) => {
      const items = searchResults.querySelectorAll('.search-result-item');
      if (!items.length) return;

      let currentIndex = Array.from(items).findIndex(item => item.classList.contains('bg-primary-100'));

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (currentIndex < items.length - 1) {
          if (currentIndex >= 0) items[currentIndex].classList.remove('bg-primary-100');
          items[currentIndex + 1].classList.add('bg-primary-100');
          items[currentIndex + 1].focus();
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (currentIndex > 0) {
          items[currentIndex].classList.remove('bg-primary-100');
          items[currentIndex - 1].classList.add('bg-primary-100');
          items[currentIndex - 1].focus();
        }
      } else if (e.key === 'Enter' && currentIndex >= 0) {
        e.preventDefault();
        items[currentIndex].click();
      }
    });

    // Initialize Search Posts
    loadSearchPosts();

    // Smooth Scrolling for Anchor Links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        document.querySelector(this.getAttribute('href')).scrollIntoView({
          behavior: 'smooth'
        });
      });
    });
  </script>
